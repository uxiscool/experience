<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ page.title | default: site.title }}</title>
    <meta name="viewport" content="width=device-width,initial-scale=1">

    <!-- CSS -->
    <link rel="stylesheet" href="{{ site.baseurl }}/css/main.css">
    <link rel="stylesheet" href="{{ site.baseurl }}/css/skills.css">

    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="{{ site.baseurl }}/ui/favicon.svg">
    <link rel="icon" type="image/png" sizes="32x32" href="{{ site.baseurl }}/ui/favicon-32.png">
    <link rel="icon" type="image/png" sizes="192x192" href="{{ site.baseurl }}/ui/favicon-192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="{{ site.baseurl }}/ui/favicon-512.png">
    <link rel="mask-icon" href="{{ site.baseurl }}/ui/safari-pinned-tab.svg" color="#FF9900">
    <link rel="apple-touch-icon" sizes="180x180" href="{{ site.baseurl }}/ui/apple-touch-icon.png">
    <link rel="shortcut icon" href="{{ site.baseurl }}/ui/favicon.ico">
    <link rel="manifest" href="{{ site.baseurl }}/ui/site.webmanifest">
    <meta name="theme-color" content="#0c2240">
    <meta name="msapplication-TileImage" content="{{ site.baseurl }}/ui/mstile-150x150.png">
    <meta name="msapplication-TileColor" content="#0c2240">

    <!-- Load Inter только на не-Apple платформах -->
    <script>
    (function(){
      var isApple =
        /Mac|iPhone|iPad|iPod/.test(navigator.platform) ||
        /Mac OS X|iPhone|iPad|iPod/.test(navigator.userAgent);
      if (isApple) return;
      if (document.getElementById('gf-inter')) return;

      var l1 = document.createElement('link');
      l1.rel = 'preconnect';
      l1.href = 'https://fonts.googleapis.com';

      var l2 = document.createElement('link');
      l2.rel = 'preconnect';
      l2.href = 'https://fonts.gstatic.com';
      l2.crossOrigin = 'anonymous';

      var css = document.createElement('link');
      css.id = 'gf-inter';
      css.rel = 'stylesheet';
      css.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap';

      document.head.append(l1, l2, css);
    })();
    </script>
  </head>

  <body class="{{ page.body_class }}">
    <!-- Проставляем lang на <html> по текущему URL -->
    <script>
    (function(){
      var base = '{{ site.baseurl }}';
      function stripBase(p){ return p.indexOf(base)===0 ? p.slice(base.length) : p; }
      var pathNoBase = stripBase(location.pathname);
      var isRU = pathNoBase.indexOf('/ru/')===0;
      document.documentElement.setAttribute('lang', isRU?'ru':'en');
      document.documentElement.setAttribute('data-lang', isRU?'ru':'en');
    })();
    </script>

    <!-- Site-wide notice banner -->
    <div id="site-banner" class="site-banner" role="region" aria-label="Site notice" hidden>
      <div class="site-banner__inner">
        <div class="site-banner__text">
          Пока это техническая версия сайта-портфолио. Контент частично заменён плейсхолдерами и рыбой, но можно посмотреть, как работает навигация и интерфейс. CV — настоящие.
        </div>
        <button class="site-banner__close" id="siteBannerClose" aria-label="Close notice">
          <img src="{{ site.baseurl }}/ui/close.svg" alt="" width="18" height="18">
        </button>
      </div>
    </div>
    <!-- /banner -->

    {% include header.html %}

    <!-- Mobile menu button -->
    <button id="burger" class="burger-btn" aria-label="Open menu" aria-controls="mobile-menu" aria-expanded="false">
      <span class="burger-box" aria-hidden="true">
        <span class="burger-inner"></span>
      </span>
    </button>

    <!-- Mobile menu overlay -->
    <nav id="mobile-menu" class="mobile-menu" aria-hidden="true" hidden>
      <div class="mobile-menu__scrim" id="mobileMenuScrim" tabindex="-1"></div>
      <div class="mobile-menu__panel" role="dialog" aria-modal="true" aria-label="Site menu">
        <ul id="mobileMenuList" class="mobile-menu__list"></ul>
      </div>
    </nav>

    <main>
      {{ content }}
    </main>

    {% include footer.html %}

    <!-- Language floater (desktop only; скрыт <980px в CSS) -->
    <a id="lang-switcher" class="lang-floater pre" href="#" aria-label="Switch language">RUS</a>

    <!-- Scripts -->
    <script>
    // ---- Banner close ----
    (function(){
      var banner = document.getElementById('site-banner');
      var btn = document.getElementById('siteBannerClose');
      if (!banner) return;
      // показываем баннер лишь если не закрыт ранее
      try {
        if (sessionStorage.getItem('siteBannerClosed') === '1') return;
      } catch(e){}
      banner.hidden = false;
      if (btn){
        btn.addEventListener('click', function(e){
          banner.hidden = true;
          try{ sessionStorage.setItem('siteBannerClosed','1'); }catch(e){}
        });
      }
    })();
    </script>

    <script>
    // ---- Burger open/close ----
    (function(){
      var burger = document.getElementById('burger');
      var menu   = document.getElementById('mobile-menu');
      var scrim  = document.getElementById('mobileMenuScrim');
      if (!burger || !menu) return;

      function openMenu(){
        menu.hidden = false;
        menu.setAttribute('aria-hidden','false');
        burger.setAttribute('aria-expanded','true');
        document.body.classList.add('lb-lock');
      }
      function closeMenu(){
        menu.setAttribute('aria-hidden','true');
        burger.setAttribute('aria-expanded','false');
        document.body.classList.remove('lb-lock');
        // скрываем после анимации (если есть)
        setTimeout(function(){ menu.hidden = true; }, 150);
      }
      burger.addEventListener('click', function(){
        var expanded = burger.getAttribute('aria-expanded') === 'true';
        expanded ? closeMenu() : openMenu();
      });
      if (scrim) scrim.addEventListener('click', closeMenu);
      document.addEventListener('keydown', function(e){
        if (e.key === 'Escape') closeMenu();
      });
    })();
    </script>

    <!-- ==== Mobile menu (clone .main-menu) ==== -->
    <script>
    document.addEventListener('DOMContentLoaded', function(){
      try {
        var list = document.getElementById('mobileMenuList');
        if (!list) return;

        var base = '{{ site.baseurl }}'; // напр. '/experience'
        function stripBase(p){ return (p.indexOf(base)===0) ? p.slice(base.length) : p; }
        function norm(p){ return (p||'').replace(/\/+$/,''); }

        var pathNoBase = stripBase(location.pathname);
        var isRU = pathNoBase.indexOf('/ru/') === 0;

        // Верхний уровень берём из десктопного меню
        var topLinks = Array.from(document.querySelectorAll('.main-menu a[href]'));
        if (!topLinks.length) return;

        // Подпункты: .subnav на странице или локализованный фолбэк
        var subLinks = Array.from(document.querySelectorAll('.subnav a[href]'));
        if (!subLinks.length){
          subLinks = [
            isRU
              ? { href: base + '/ru/cases/',        text: 'Кейсы' }
              : { href: base + '/cases/',           text: 'Cases' },
            isRU
              ? { href: base + '/ru/pet-projects/', text: 'Пет-проекты' }
              : { href: base + '/pet-projects/',    text: 'Pet projects' }
          ].map(function(it){
            var a = document.createElement('a');
            a.href = it.href; a.textContent = it.text; return a;
          });
        }

        // К какому пункту подвешивать подпункты: «Работы/Works» по URL (не по тексту)
        var worksPath = isRU ? (base + '/ru/') : (base + '/');
        var worksIndex = topLinks.findIndex(function(a){ return norm(a.pathname) === norm(worksPath); });

        // Рендер списка
        list.innerHTML = '';
        topLinks.forEach(function(a, i){
          var li = document.createElement('li');
          var b  = document.createElement('a');
          b.className = 'mobile-menu__link';
          b.href = a.getAttribute('href');
          b.textContent = a.textContent;
          li.appendChild(b);
          list.appendChild(li);

          if (i === worksIndex && subLinks.length){
            var ul = document.createElement('ul');
            ul.className = 'mobile-sub';
            subLinks.forEach(function(s){
              var sli = document.createElement('li');
              var sa  = document.createElement('a');
              sa.className = 'mobile-menu__link sub';
              sa.href = s.getAttribute('href');
              sa.textContent = s.textContent;
              sli.appendChild(sa); ul.appendChild(sli);
            });
            li.appendChild(ul);
          }
        });

        // Языковой пункт — в самый низ
        var url  = '{{ page.url | default: "/" }}';
        var alt  = '{{ page.alt_url | default: "" }}';
        var switchHref = alt && alt !== ''
          ? (base + alt)
          : (isRU ? base + url.replace(/^\/ru\//,'/')
                  : base + (url === '/' ? '/ru/' : ('/ru' + url)));
        var switchLabel = isRU ? 'ENG' : 'RUS';

        var langLi = document.createElement('li');
        var langA  = document.createElement('a');
        langA.className = 'mobile-menu__link';
        langA.href = switchHref;
        langA.textContent = switchLabel;
        langLi.appendChild(langA);
        list.appendChild(langLi);
      } catch(e){
        console.error('[mobile menu build error]', e);
      }
    });
    </script>

    <!-- === Language floater logic === -->
    <script>
    (function(){
      var sw = document.getElementById('lang-switcher');
      if (!sw) return;

      // Подготовка href и метки
      var base = '{{ site.baseurl }}';
      var url  = '{{ page.url | default: "/" }}';
      var alt  = '{{ page.alt_url | default: "" }}';

      function stripBase(p){ return p.indexOf(base)===0 ? p.slice(base.length) : p; }
      var pathNoBase = stripBase(location.pathname);
      var isRU = pathNoBase.indexOf('/ru/') === 0;

      sw.textContent = isRU ? 'ENG' : 'RUS';

      var href = alt && alt !== ''
        ? (base + alt)
        : (isRU ? base + url.replace(/^\/ru\//,'/')
                : base + (url === '/' ? '/ru/' : ('/ru' + url)));
      sw.setAttribute('href', href);

      // Анимация: только первый раз за сессию
      try {
        var seen = sessionStorage.getItem('langIntroSeen') === '1';
        setTimeout(function(){
          sw.classList.remove('pre');
          if (!seen){
            sw.classList.add('intro');
            setTimeout(function(){
              sw.classList.remove('intro');
              sw.classList.add('settled');
              sessionStorage.setItem('langIntroSeen','1');
            }, 2000 + 3600); // 2s delay + 3.6s move
          } else {
            sw.classList.add('settled');
          }
        }, 2000); // показываем через 2s
      } catch(e){
        sw.classList.remove('pre');
        sw.classList.add('settled');
      }
    })();
    </script>

    {% include lightbox_loader.html %}
  </body>
</html>
