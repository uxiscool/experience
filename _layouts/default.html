<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ page.title | default: site.title }}</title>
    <link rel="stylesheet" href="{{ site.baseurl }}/css/main.css">
    <link rel="stylesheet" href="{{ site.baseurl }}/css/skills.css">
    <meta name="viewport" content="width=device-width,initial-scale=1">
 <!-- Favicons -->
<link rel="icon" type="image/svg+xml" href="{{ site.baseurl }}/ui/favicon.svg">
<link rel="icon" type="image/png" sizes="32x32" href="{{ site.baseurl }}/ui/favicon-32.png">
<link rel="icon" type="image/png" sizes="192x192" href="{{ site.baseurl }}/ui/favicon-192.png">
<link rel="icon" type="image/png" sizes="512x512" href="{{ site.baseurl }}/ui/favicon-512.png">
<link rel="mask-icon" href="{{ site.baseurl }}/ui/safari-pinned-tab.svg" color="#FF9900">
<link rel="apple-touch-icon" sizes="180x180" href="{{ site.baseurl }}/ui/apple-touch-icon.png">
<link rel="shortcut icon" href="{{ site.baseurl }}/ui/favicon.ico">
<link rel="manifest" href="{{ site.baseurl }}/ui/site.webmanifest">
<meta name="theme-color" content="#0c2240">
<meta name="msapplication-TileImage" content="{{ site.baseurl }}/ui/mstile-150x150.png">
<meta name="msapplication-TileColor" content="#0c2240">
<!-- Load Inter только на не-Apple платформах -->
<script>
(function(){
  var isApple =
    /Mac|iPhone|iPad|iPod/.test(navigator.platform) ||
    /Mac OS X|iPhone|iPad|iPod/.test(navigator.userAgent);

  if (isApple) return; // На macOS/iOS не грузим вообще

  // Не дублируем, если вдруг уже вставлено
  if (document.getElementById('gf-inter')) return;

  var l1 = document.createElement('link');
  l1.rel = 'preconnect';
  l1.href = 'https://fonts.googleapis.com';

  var l2 = document.createElement('link');
  l2.rel = 'preconnect';
  l2.href = 'https://fonts.gstatic.com';
  l2.crossOrigin = 'anonymous';

  var css = document.createElement('link');
  css.id = 'gf-inter';
  css.rel = 'stylesheet';
  css.href = 'https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap';

  document.head.append(l1, l2, css);
})();
</script>

  </head>
  <body class="{{ page.body_class }}">
    {% include header.html %}
    <!-- Mobile menu button -->
<button id="burger" class="burger-btn" aria-label="Open menu" aria-controls="mobile-menu" aria-expanded="false">
  <img id="burgerIcon" src="{{ site.baseurl }}/ui/menu.svg" alt="">
</button>
<!-- Mobile menu overlay -->
<nav id="mobile-menu" class="mobile-menu" hidden>
  <div class="mobile-menu__inner">
    <!-- Опционально: можно поместить сюда логотип/заголовок -->
    <ul id="mobileMenuList" class="mobile-menu__list"></ul>
  </div>
</nav>
<!-- Download overlay (mobile) -->
<nav id="download-overlay" class="mobile-menu" hidden aria-label="Download CV">
  <div class="mobile-menu__inner">
    <ul class="download-list">
      <li>
        <a class="mobile-menu__link download-link" href="{{ site.baseurl }}/vladimir_zhukov_cv_rus_v1.1.pdf">
          <img class="dl-ico" src="{{ site.baseurl }}/ui/icon_download_32.svg" alt="" aria-hidden="true">
          <span>PDF на русском</span>
          <span class="dl-size">1.69&nbsp;MB</span>
        </a>
      </li>
      <li>
        <a class="mobile-menu__link download-link" href="{{ site.baseurl }}/vladimir_zhukov_cv_eng_v1.pdf">
          <img class="dl-ico" src="{{ site.baseurl }}/ui/icon_download_32.svg" alt="" aria-hidden="true">
          <span>PDF in English</span>
          <span class="dl-size">1.99&nbsp;MB</span>
        </a>
      </li>
    </ul>
  </div>
</nav>

    <main>
      {{ content }}
    </main>
    {% include footer.html %}
    <!-- Back to top -->
<button id="to-top" class="to-top" aria-label="Back to top" title="Back to top">
  <img src="{{ site.baseurl }}/ui/arrow_up.svg" alt="">
</button>

<script>
/* ===== Mini helpers ===== */
(function(){
  window.openPetGallery = function(cardIndex, startIndex){
    const g = (window.PET_GALLERIES && window.PET_GALLERIES[cardIndex]) || null;
    if (!g || !g.length) return;
    window.openLightbox(g, startIndex || 0);
  };
})();

(function(){
  // уже есть:
  window.openPetGallery = function(cardIndex, startIndex){
    const g = (window.PET_GALLERIES && window.PET_GALLERIES[cardIndex]) || null;
    if (!g || !g.length) return;
    window.openLightbox(g, startIndex || 0);
  };

  // добавь это:
  window.openHomeGallery = function(caseIndex, startIndex){
    const g = (window.CASE_GALLERY_HOME && window.CASE_GALLERY_HOME[caseIndex]) || null;
    if (!g || !g.length) return;
    window.openLightbox(g, startIndex || 0);
  };
  window.openCaseGallery = function(caseIndex, startIndex){
  const g = (window.CASE_GALLERY_ALL && window.CASE_GALLERY_ALL[caseIndex]) || null;
  if (!g || !g.length) return;
  window.openLightbox(g, startIndex || 0);
};
})();

/* ===== Lightbox ===== */
(function(){
  var LIGHTBOX = document.getElementById('lightbox');
  var IMG = document.getElementById('lightbox-img');
  var CAP = document.getElementById('lightbox-caption');
  var THUMBS = document.getElementById('lightbox-thumbs');
  var STAGE = document.querySelector('.lightbox-stage');
  var state = { arr:[], i:0, req:0 };
  var onKey = null;

  function setLoading(on){
    if (!STAGE) return;
    if (on) STAGE.classList.add('is-loading');
    else STAGE.classList.remove('is-loading');
  }

  window.openLightbox = function(arr, index){
    state.arr = arr || [];
    state.i = Math.max(0, Math.min(index || 0, state.arr.length - 1));
    if (!state.arr.length) return;

    LIGHTBOX.style.display = 'block';
    document.body.classList.add('lb-lock');
    bindKeys();
    render(0);
  };

  window.closeLightbox = function(){
    LIGHTBOX.style.display = 'none';
    document.body.classList.remove('lb-lock');
    unbindKeys();
  };

window.lightboxPrev = function(){
  if (!state.arr.length) return;
  state.i = (state.i - 1 + state.arr.length) % state.arr.length;
  render(-1); // ← направление: влево
};
window.lightboxNext = function(){
  if (!state.arr.length) return;
  state.i = (state.i + 1) % state.arr.length;
  render(1);  // ← направление: вправо
};

function render(dir){
  var item = state.arr[state.i]; if (!item) return;

  // помечаем этот вызов как «последний»
  var req = ++state.req;

  setLoading(true);
  var oldImg = IMG;
  var nextImg = new Image();
  nextImg.className = 'lightbox-img lb-anim ' + (dir > 0 ? 'lb-enter-right' : dir < 0 ? 'lb-enter-left' : 'lb-center');
  nextImg.alt = item.caption || '';

  nextImg.onload = function(){
    // если за это время пришёл другой render — выходим
    if (req !== state.req) return;

    setLoading(false);
    CAP.textContent = item.caption || '';

    if (dir === 0){
      // первый показ / клик по миниатюре — без слайда
      oldImg.src = nextImg.src;
      oldImg.alt = nextImg.alt;
      renderThumbs();
      return;
    }

    if (oldImg && oldImg.id === 'lightbox-img') oldImg.id = '';
    nextImg.id = 'lightbox-img';
    STAGE.appendChild(nextImg);
    void nextImg.offsetWidth;
    nextImg.classList.remove('lb-enter-right','lb-enter-left');
    nextImg.classList.add('lb-center');

    if (oldImg){
      oldImg.classList.add('lb-anim', dir > 0 ? 'lb-exit-left' : 'lb-exit-right');
      oldImg.addEventListener('transitionend', function onEnd(){
        oldImg.removeEventListener('transitionend', onEnd);
        try { STAGE.removeChild(oldImg); } catch(e){}
      }, { once:true });
    }

    IMG = nextImg;
    renderThumbs();
  };

  nextImg.onerror = function(){
    if (req !== state.req) return;

    setLoading(false);
    if (dir === 0){
      oldImg.src = item.src;
      renderThumbs();
    } else {
      if (oldImg && oldImg.id === 'lightbox-img') oldImg.id = '';
      nextImg.id = 'lightbox-img';
      nextImg.className = 'lightbox-img lb-center';
      nextImg.src = item.src;
      STAGE.appendChild(nextImg);
      if (oldImg){ try { STAGE.removeChild(oldImg); } catch(e){} }
      IMG = nextImg;
      renderThumbs();
    }
  };

  nextImg.src = item.src;
}

  function renderThumbs(){
    if (!THUMBS) return;
    var wrap = document.createElement('div');
    wrap.className = 'lightbox-thumbs';
    state.arr.forEach(function(it, idx){
      var t = document.createElement('img');
      t.className = 'lightbox-thumb' + (idx===state.i ? ' is-active' : '');
      t.src = it.src; t.alt = it.caption || '';
      t.onclick = function(){ state.i = idx; render(0); };
      wrap.appendChild(t);
    });
    THUMBS.innerHTML = '';
    THUMBS.appendChild(wrap);
  }
  function bindKeys(){
    if (onKey) return;
    onKey = function(e){
      if (e.key === 'Escape'){ window.closeLightbox(); }
      else if (e.key === 'ArrowLeft'){ window.lightboxPrev(); }
      else if (e.key === 'ArrowRight'){ window.lightboxNext(); }
    };
    window.addEventListener('keydown', onKey);
  }
  function unbindKeys(){
    if (!onKey) return;
    window.removeEventListener('keydown', onKey);
    onKey = null;
  }

})();

/* ===== Cases galleries data ===== */
window.CASE_GALLERY_HOME = [
  {% for c in site.cases %}
    (function(){
      var arr = [];
      {% if c.stages %}
        {% for st in c.stages %}
          {% for img in st.images %}
            {% unless img.home == false %}
              {% assign src = img.src | default: img.file | prepend: c.images_base | default: img.src %}
              arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
            {% endunless %}
          {% endfor %}
        {% endfor %}
      {% elsif c.images %}
        {% for img in c.images %}
          {% assign src = img.src | default: img.file | prepend: c.images_base | default: img.src %}
          arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
        {% endfor %}
      {% endif %}
      return arr;
    })(){% unless forloop.last %},{% endunless %}
  {% endfor %}
];

window.CASE_GALLERY_ALL = [
  {% for c in site.cases %}
    (function(){
      var arr = [];
      {% if c.stages %}
        {% for st in c.stages %}
          {% for img in st.images %}
            {% assign src = img.src | default: img.file | prepend: c.images_base | default: img.src %}
            arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
          {% endfor %}
        {% endfor %}
      {% elsif c.images %}
        {% for img in c.images %}
          {% assign src = img.src | default: img.file | prepend: c.images_base | default: img.src %}
          arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
        {% endfor %}
      {% endif %}
      return arr;
    })(){% unless forloop.last %},{% endunless %}
  {% endfor %}
];

window.PET_GALLERIES = [
  {% assign items = site.petprojects %}
  {% for p in items %}
    (function(){
      var arr = [];
      {% if p.gallery %}
        {% for img in p.gallery %}
          {% assign src = img.src | default: img.file | prepend: p.images_base | default: img.src %}
          arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
        {% endfor %}
      {% endif %}
      return arr;
    })(){% unless forloop.last %},{% endunless %}
  {% endfor %}
];

/* ===== Lazy images (pet projects + cases) ===== */
/* ===== Lazy images (pet projects + cases) ===== */
/* Надёжный вариант: IO + резервная проверка на scroll/resize/load */
(function(){
  function markLoaded(img){
    img.classList.add('is-loaded');
    var box = img.closest('.case-img-wrap, .pp-media, .pp-media-link');
    if (box) box.classList.add('has-loaded');
  }

  function loadLazyImage(img){
    if (img.dataset._loading) return;
    img.dataset._loading = '1';

    var src = img.getAttribute('data-src');
    if (!src) return;

    // На всякий случай попросим браузер лениво грузить и сам
    img.setAttribute('loading', 'lazy');

    var ph = new Image();
    ph.onload = function(){
      img.src = src;
      (img.decode ? img.decode() : Promise.resolve())
        .catch(function(){})
        .finally(function(){ markLoaded(img); });
    };
    ph.onerror = function(){ markLoaded(img); };
    ph.src = src;
  }

  // IntersectionObserver — основной триггер
  var io = ('IntersectionObserver' in window)
    ? new IntersectionObserver(function(entries){
        entries.forEach(function(entry){
          if (entry.isIntersecting){
            io.unobserve(entry.target);
            loadLazyImage(entry.target);
          }
        });
      }, { rootMargin: '400px 0px' })  // захватываем побольше за пределами экрана
    : null;

  function forEachLazy(cb){
    document.querySelectorAll('img.lazy-img[data-src]:not(.is-loaded)').forEach(cb);
  }

  function initLazy(){
    forEachLazy(function(img){
      if (io) io.observe(img);
      else loadLazyImage(img);
    });
  }

  // Резервная проверка (если IO не отработал из-за нулевой геометрии)
  var scheduled = false;
  function checkLazyNow(){
    scheduled = false;
    var vh = window.innerHeight || document.documentElement.clientHeight || 0;
    forEachLazy(function(img){
      if (img.dataset._loading) return;
      var r = img.getBoundingClientRect();
      // если элемент в пределах расширенного вьюпорта — грузим
      if (r.bottom > -400 && r.top < vh + 400){
        if (io) io.unobserve(img);
        loadLazyImage(img);
      }
    });
  }
  function scheduleCheck(){
    if (scheduled) return;
    scheduled = true;
    requestAnimationFrame(checkLazyNow);
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', function(){
      initLazy();
      scheduleCheck();
      setTimeout(scheduleCheck, 300);
      setTimeout(scheduleCheck, 1200);
    });
  } else {
    initLazy();
    scheduleCheck();
    setTimeout(scheduleCheck, 300);
    setTimeout(scheduleCheck, 1200);
  }

  // Реакция на изменения вьюпорта/страницы
  window.addEventListener('scroll', scheduleCheck, { passive: true });
  window.addEventListener('resize', scheduleCheck, { passive: true });
  window.addEventListener('orientationchange', scheduleCheck, { passive: true });
  window.addEventListener('load', scheduleCheck, { passive: true });
  document.addEventListener('visibilitychange', function(){
    if (document.visibilityState === 'visible') scheduleCheck();
  });

})();

/* Back-to-top behavior (smooth show/hide + smooth scroll) */
(function(){
  var btn = document.getElementById('to-top');
  if (!btn) return;

  // через сколько пикселей скролла показывать кнопку
  var SHOW_AFTER = 400;

  var scheduled = false;
  function update(){
    scheduled = false;
    var y = window.pageYOffset || document.documentElement.scrollTop || 0;
    if (y > SHOW_AFTER){
      btn.classList.add('is-visible');
    } else {
      btn.classList.remove('is-visible');
    }
  }

  window.addEventListener('scroll', function(){
    if (scheduled) return;
    scheduled = true;
    requestAnimationFrame(update);
  }, { passive: true });

  window.addEventListener('resize', update, { passive: true });

  btn.addEventListener('click', function(e){
    e.preventDefault();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // начальная проверка
  update();
})();

/* ==== Mobile menu (clone .main-menu) ==== */
(function(){
  var btn = document.getElementById('burger');
  var icon = document.getElementById('burgerIcon');
  var panel = document.getElementById('mobile-menu');
  var list = document.getElementById('mobileMenuList');
  if (!btn || !icon || !panel || !list) return;

  var OPEN_CLASS = 'mm-open';
  var SRC_MENU = document.querySelector('.main-menu');
  var btnHomeParent = btn.parentNode;  // куда вернуть кнопку после закрытия
  var btnNextSibling = btn.nextSibling;

   function buildMobileMenu(){
    list.innerHTML = '';
    if (!SRC_MENU) return;

    // 1) Собираем все ссылки верхнего уровня
    var topLinks = Array.from(SRC_MENU.querySelectorAll('a[href]'));

  // 2) Собираем подпункты (если есть на странице) + ФОЛБЭК
var subLinks = Array.from(document.querySelectorAll('.subnav a[href]'));
if (!subLinks.length){
  // Фолбэк: подменю Works всегда доступно из любого раздела
  subLinks = [
    { href: '{{ site.baseurl }}/cases/',         text: 'Cases' },
    { href: '{{ site.baseurl }}/pet-projects/',  text: 'Pet projects' }
  ].map(function(it){
    var a = document.createElement('a');
    a.setAttribute('href', it.href);
    a.textContent = it.text;
    return a;
  });
}

    // 3) Определим, к какому пункту в топ-меню подвесить подпункты:
    //    ищем пункт, название которого похоже на "Works"
    var worksIndex = topLinks.findIndex(function(a){
      var t = (a.textContent || '').trim().toLowerCase();
      return t.includes('work'); // достаточно надёжно для твоей структуры
    });

    // 4) Рендерим верхний уровень
    topLinks.forEach(function(a, idx){
      var li = document.createElement('li');
      var m = document.createElement('a');
      m.className = 'mobile-menu__link';
      m.href = a.getAttribute('href');
      m.textContent = a.textContent.trim();
if (location.pathname.replace(/\/+$/, '') === m.pathname.replace(/\/+$/, '')){
  m.classList.add('current');
}

      m.addEventListener('click', closeMenu);
      li.appendChild(m);

      // 5) Если это пункт Works и у нас есть подпункты — добавляем подсписок
      if (idx === worksIndex && subLinks.length){
        var subUl = document.createElement('ul');
        subUl.className = 'mobile-menu__sublist';

        subLinks.forEach(function(sa){
          var sli = document.createElement('li');
          var s = document.createElement('a');
          s.className = 'mobile-menu__sublink';
          s.href = sa.getAttribute('href');
          s.textContent = sa.textContent.trim();
          if (location.pathname.replace(/\/+$/, '') === s.pathname.replace(/\/+$/, '')){
  s.classList.add('current');
}
          s.addEventListener('click', closeMenu);
          sli.appendChild(s);
          subUl.appendChild(sli);
        });

        li.appendChild(subUl);
      }

      list.appendChild(li);
    });
  }

  function openMenu(){
    if (panel.hasAttribute('hidden')) panel.removeAttribute('hidden');
    panel.classList.add('is-open');
    document.body.classList.add(OPEN_CLASS);
    btn.classList.add('is-open');
    btn.setAttribute('aria-expanded', 'true');
    icon.src = '{{ site.baseurl }}/ui/close.svg';

    // Переносим кнопку внутрь оверлея, чтобы точно была поверх
    panel.appendChild(btn);

    window.addEventListener('keydown', onKey, { passive: true });
  }
  function closeMenu(){
    panel.classList.remove('is-open');
    document.body.classList.remove(OPEN_CLASS);
    btn.classList.remove('is-open');
    btn.setAttribute('aria-expanded', 'false');
    icon.src = '{{ site.baseurl }}/ui/menu.svg';

    // Возвращаем кнопку туда, где она была
    if (btnHomeParent){
      if (btnNextSibling) btnHomeParent.insertBefore(btn, btnNextSibling);
      else btnHomeParent.appendChild(btn);
    }

    window.removeEventListener('keydown', onKey);
    requestAnimationFrame(function(){ panel.setAttribute('hidden',''); });
  }
  function toggleMenu(){
    if (document.body.classList.contains(OPEN_CLASS)) closeMenu();
    else openMenu();
  }
  function onKey(e){
    if (e.key === 'Escape') closeMenu();
  }

  btn.addEventListener('click', function(e){ e.preventDefault(); toggleMenu(); });

  if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', buildMobileMenu);
  else buildMobileMenu();
})();

(function(){
  var trigger = document.getElementById('cv-download-trigger');
  var pop = document.getElementById('cv-download-pop');
  var sheet = document.getElementById('download-overlay');
  if (!trigger || !pop || !sheet) return;

  var MQ = window.matchMedia('(min-width: 981px)');
  var hideTimer = null;

  function openPop(){
    // позиционирование в пределах окна (fixed к вьюпорту)
    var r = trigger.getBoundingClientRect();
    pop.hidden = false;
    pop.setAttribute('aria-hidden', 'false');
    pop.classList.add('is-open');

    // сначала сделать видимым → получить размеры
    var w = pop.offsetWidth, h = pop.offsetHeight;
    var left = r.left; 
    var top = r.bottom + 8;

    // не вылезаем за края окна
    var pad = 12;
    if (left + w + pad > window.innerWidth) left = window.innerWidth - w - pad;
    if (left < pad) left = pad;
    if (top + h + pad > window.innerHeight) top = Math.max(pad, r.top - h - 8);

    pop.style.left = left + 'px';
    pop.style.top = top + 'px';
  }
  function closePop(){
    pop.classList.remove('is-open');
    pop.setAttribute('aria-hidden', 'true');
    pop.hidden = true;
  }

  function openSheet(){
    sheet.hidden = false;
    document.body.classList.add('mm-open');
    // скроем бургер, если открыт
    var mobileMenu = document.getElementById('mobile-menu');
    if (mobileMenu) mobileMenu.hidden = true;
  }
  function closeSheet(){
    sheet.hidden = true;
    document.body.classList.remove('mm-open');
  }

  // Десктоп: hover-сценарий
  function bindDesktop(){
    trigger.addEventListener('mouseenter', function(e){
      clearTimeout(hideTimer);
      openPop();
    });
    trigger.addEventListener('mouseleave', function(){
      clearTimeout(hideTimer);
      hideTimer = setTimeout(closePop, 140);
    });
    pop.addEventListener('mouseenter', function(){
      clearTimeout(hideTimer);
    });
    pop.addEventListener('mouseleave', function(){
      hideTimer = setTimeout(closePop, 140);
    });

    // кликом по ссылке — ведём на ENG PDF, как раньше
    trigger.addEventListener('click', function(e){
      // разрешаем обычный переход по href у триггера
    });
  }

  // Мобильный: по клику открываем лист
  function bindMobile(){
    trigger.addEventListener('click', function(e){
      e.preventDefault();
      openSheet();
    });
    // закрытие по Esc и по бэкдропу (клик по внешней зоне)
    sheet.addEventListener('click', function(e){
      if (e.target === sheet) closeSheet();
    });
    document.addEventListener('keydown', function(e){
      if (e.key === 'Escape' && !sheet.hidden) closeSheet();
    });
    // при клике по пунктам — закрываем
    sheet.querySelectorAll('.download-link').forEach(function(a){
      a.addEventListener('click', function(){ closeSheet(); });
    });
  }

  // Переключение режимов
  if (MQ.matches){ bindDesktop(); } else { bindMobile(); }
  MQ.addEventListener('change', function(ev){
    // прибираем состояние и заново биндимся
    closePop(); closeSheet();
    var clone = trigger.cloneNode(true);
    trigger.parentNode.replaceChild(clone, trigger);
    trigger = clone;
    if (ev.matches){ bindDesktop(); } else { bindMobile(); }
  });
})();
</script>

  </body>
</html>
