<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ page.title | default: site.title }}</title>
    <link rel="stylesheet" href="{{ site.baseurl }}/css/main.css">
    <link rel="stylesheet" href="{{ site.baseurl }}/css/skills.css">
    <meta name="viewport" content="width=device-width,initial-scale=1">
  </head>
  <body class="{{ page.body_class }}">
    {% include header.html %}
    <main>
      {{ content }}
    </main>
    {% include footer.html %}
    <!-- Back to top -->
<button id="to-top" class="to-top" aria-label="Back to top" title="Back to top">
  <img src="{{ site.baseurl }}/ui/arrow_up.svg" alt="">
</button>


<script>
/* ===== Mini helpers ===== */
(function(){
  window.openPetGallery = function(cardIndex, startIndex){
    const g = (window.PET_GALLERIES && window.PET_GALLERIES[cardIndex]) || null;
    if (!g || !g.length) return;
    window.openLightbox(g, startIndex || 0);
  };
})();

(function(){
  // уже есть:
  window.openPetGallery = function(cardIndex, startIndex){
    const g = (window.PET_GALLERIES && window.PET_GALLERIES[cardIndex]) || null;
    if (!g || !g.length) return;
    window.openLightbox(g, startIndex || 0);
  };

  // добавь это:
  window.openHomeGallery = function(caseIndex, startIndex){
    const g = (window.CASE_GALLERY_HOME && window.CASE_GALLERY_HOME[caseIndex]) || null;
    if (!g || !g.length) return;
    window.openLightbox(g, startIndex || 0);
  };
  window.openCaseGallery = function(caseIndex, startIndex){
  const g = (window.CASE_GALLERY_ALL && window.CASE_GALLERY_ALL[caseIndex]) || null;
  if (!g || !g.length) return;
  window.openLightbox(g, startIndex || 0);
};
})();

/* ===== Lightbox ===== */
(function(){
  var LIGHTBOX = document.getElementById('lightbox');
  var IMG = document.getElementById('lightbox-img');
  var CAP = document.getElementById('lightbox-caption');
  var THUMBS = document.getElementById('lightbox-thumbs');
  var STAGE = document.querySelector('.lightbox-stage');
  var state = { arr:[], i:0 };
  var onKey = null;

  function setLoading(on){
    if (!STAGE) return;
    if (on) STAGE.classList.add('is-loading');
    else STAGE.classList.remove('is-loading');
  }

  window.openLightbox = function(arr, index){
    state.arr = arr || [];
    state.i = Math.max(0, Math.min(index || 0, state.arr.length - 1));
    if (!state.arr.length) return;

    LIGHTBOX.style.display = 'block';
    document.body.classList.add('lb-lock');
    bindKeys();
    render(0);
  };

  window.closeLightbox = function(){
    LIGHTBOX.style.display = 'none';
    document.body.classList.remove('lb-lock');
    unbindKeys();
  };

window.lightboxPrev = function(){
  if (!state.arr.length) return;
  state.i = (state.i - 1 + state.arr.length) % state.arr.length;
  render(-1); // ← направление: влево
};
window.lightboxNext = function(){
  if (!state.arr.length) return;
  state.i = (state.i + 1) % state.arr.length;
  render(1);  // ← направление: вправо
};

function render(dir){
  var item = state.arr[state.i]; if (!item) return;

  // 1) грузим новый кадр «в сторонке»
  setLoading(true);
  var oldImg = IMG;                                  // текущая картинка (может отсутствовать на первом рендере)
  var nextImg = new Image();
  nextImg.className = 'lightbox-img lb-anim ' + (dir > 0 ? 'lb-enter-right' : dir < 0 ? 'lb-enter-left' : 'lb-center');
  nextImg.alt = item.caption || '';
  nextImg.onload = function(){
    setLoading(false);
    CAP.textContent = item.caption || '';

    // 2) вставляем новый IMG, готовим классы для анимации
    if (dir === 0){
      // первый показ: без слайда, просто подменяем src у старого элемента
      oldImg.src = nextImg.src;
      oldImg.alt = nextImg.alt;
      return;
    }

    // уберём id у старого, чтобы не было дубликатов
    if (oldImg && oldImg.id === 'lightbox-img') oldImg.id = '';

    nextImg.id = 'lightbox-img';
    STAGE.appendChild(nextImg);

    // принудительный reflow, чтобы transition стартовал корректно
    void nextImg.offsetWidth;

    // вход нового и выход старого
    nextImg.classList.remove('lb-enter-right','lb-enter-left');
    nextImg.classList.add('lb-center');

    if (oldImg){
      oldImg.classList.add('lb-anim', dir > 0 ? 'lb-exit-left' : 'lb-exit-right');
      oldImg.addEventListener('transitionend', function onEnd(){
        oldImg.removeEventListener('transitionend', onEnd);
        try { STAGE.removeChild(oldImg); } catch(e){}
      }, { once:true });
    }

    // 3) обновляем ссылку на текущую картинку
    IMG = nextImg;
  };

  nextImg.onerror = function(){
    setLoading(false);
    // на ошибке просто меняем src без анимации
    if (dir === 0){
      oldImg.src = item.src;
    } else {
      if (oldImg && oldImg.id === 'lightbox-img') oldImg.id = '';
      nextImg.id = 'lightbox-img';
      nextImg.className = 'lightbox-img lb-center';
      nextImg.src = item.src; // всё равно покажем «битую» ссылку — поведёт себя как пустой
      STAGE.appendChild(nextImg);
      if (oldImg){ try { STAGE.removeChild(oldImg); } catch(e){} }
      IMG = nextImg;
    }
  };

  nextImg.src = item.src;
}


  function renderThumbs(){
    if (!THUMBS) return;
    var wrap = document.createElement('div');
    wrap.className = 'lightbox-thumbs';
    state.arr.forEach(function(it, idx){
      var t = document.createElement('img');
      t.className = 'lightbox-thumb' + (idx===state.i ? ' is-active' : '');
      t.src = it.src; t.alt = it.caption || '';
      t.onclick = function(){ state.i = idx; render(); };
      wrap.appendChild(t);
    });
    THUMBS.innerHTML = '';
    THUMBS.appendChild(wrap);
  }
  function bindKeys(){
    if (onKey) return;
    onKey = function(e){
      if (e.key === 'Escape'){ window.closeLightbox(); }
      else if (e.key === 'ArrowLeft'){ window.lightboxPrev(); }
      else if (e.key === 'ArrowRight'){ window.lightboxNext(); }
    };
    window.addEventListener('keydown', onKey);
  }
  function unbindKeys(){
    if (!onKey) return;
    window.removeEventListener('keydown', onKey);
    onKey = null;
  }

})();
</script>

<script>
/* ===== Cases galleries data ===== */
window.CASE_GALLERY_HOME = [
  {% for c in site.cases %}
    (function(){
      var arr = [];
      {% if c.stages %}
        {% for st in c.stages %}
          {% for img in st.images %}
            {% unless img.home == false %}
              {% assign src = img.src | default: img.file | prepend: c.images_base | default: img.src %}
              arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
            {% endunless %}
          {% endfor %}
        {% endfor %}
      {% elsif c.images %}
        {% for img in c.images %}
          {% assign src = img.src | default: img.file | prepend: c.images_base | default: img.src %}
          arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
        {% endfor %}
      {% endif %}
      return arr;
    })(){% unless forloop.last %},{% endunless %}
  {% endfor %}
];

window.CASE_GALLERY_ALL = [
  {% for c in site.cases %}
    (function(){
      var arr = [];
      {% if c.stages %}
        {% for st in c.stages %}
          {% for img in st.images %}
            {% assign src = img.src | default: img.file | prepend: c.images_base | default: img.src %}
            arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
          {% endfor %}
        {% endfor %}
      {% elsif c.images %}
        {% for img in c.images %}
          {% assign src = img.src | default: img.file | prepend: c.images_base | default: img.src %}
          arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
        {% endfor %}
      {% endif %}
      return arr;
    })(){% unless forloop.last %},{% endunless %}
  {% endfor %}
];

window.PET_GALLERIES = [
  {% assign items = site.petprojects %}
  {% for p in items %}
    (function(){
      var arr = [];
      {% if p.gallery %}
        {% for img in p.gallery %}
          {% assign src = img.src | default: img.file | prepend: p.images_base | default: img.src %}
          arr.push({ src: "{{ site.baseurl }}{{ src }}", caption: {{ img.caption | jsonify }} });
        {% endfor %}
      {% endif %}
      return arr;
    })(){% unless forloop.last %},{% endunless %}
  {% endfor %}
];
</script>

<script>
/* ===== Lazy images (pet projects + cases) ===== */
(function(){
  function loadLazyImage(img){
    if (img.dataset._loading) return;
    img.dataset._loading = '1';

    var src = img.getAttribute('data-src');
    if (!src) return;

    var ph = new Image();
    ph.onload = function(){
      img.src = src;
      (img.decode ? img.decode() : Promise.resolve())
        .catch(function(){})
        .finally(function(){
          img.classList.add('is-loaded');

          // пометить родителя (на случай стилизации)
          var box = img.closest('.case-img-wrap, .pp-media, .pp-media-link');
          if (box) box.classList.add('has-loaded');
        });
    };
    ph.onerror = function(){
      img.classList.add('is-loaded');

      // пометить родителя и при ошибке
      var box = img.closest('.case-img-wrap, .pp-media, .pp-media-link');
      if (box) box.classList.add('has-loaded');
    };
    ph.src = src;
  }

  var io = ('IntersectionObserver' in window)
    ? new IntersectionObserver(function(entries){
        entries.forEach(function(entry){
          if (entry.isIntersecting) {
            io.unobserve(entry.target);
            loadLazyImage(entry.target);
          }
        });
      }, { rootMargin: '200px 0px' })
    : null;

  function initLazy(){
    var imgs = document.querySelectorAll('img.lazy-img[data-src]');
    imgs.forEach(function(img){
      if (io) io.observe(img);
      else loadLazyImage(img);
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initLazy);
  } else {
    initLazy();
  }
})();
</script>
<script>
/* Back-to-top behavior (smooth show/hide + smooth scroll) */
(function(){
  var btn = document.getElementById('to-top');
  if (!btn) return;

  // через сколько пикселей скролла показывать кнопку
  var SHOW_AFTER = 400;

  var scheduled = false;
  function update(){
    scheduled = false;
    var y = window.pageYOffset || document.documentElement.scrollTop || 0;
    if (y > SHOW_AFTER){
      btn.classList.add('is-visible');
    } else {
      btn.classList.remove('is-visible');
    }
  }

  window.addEventListener('scroll', function(){
    if (scheduled) return;
    scheduled = true;
    requestAnimationFrame(update);
  }, { passive: true });

  window.addEventListener('resize', update, { passive: true });

  btn.addEventListener('click', function(e){
    e.preventDefault();
    window.scrollTo({ top: 0, behavior: 'smooth' });
  });

  // начальная проверка
  update();
})();
</script>
  </body>
</html>
