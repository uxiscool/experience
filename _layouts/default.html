<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <title>{{ page.title | default: site.title }}</title>
    <link rel="stylesheet" href="{{ site.baseurl }}/css/main.css">
    <link rel="stylesheet" href="{{ site.baseurl }}/css/skills.css">
    <meta name="viewport" content="width=device-width,initial-scale=1">
  </head>
  <body class="{{ page.body_class }}">
    {% include header.html %}
    <main>
      {{ content }}
    </main>
    {% include footer.html %}

<script>
/* ===== Mini helpers (унифицировано) ===== */
(function(){
  // Pet projects
  window.openPetGallery = function(cardIndex, startIndex){
    const g = (window.PET_GALLERIES && window.PET_GALLERIES[cardIndex]) || null;
    if (!g || !g.length) return;
    window.openLightbox(g, startIndex || 0);
  };

  // Works (главная)
  window.openHomeGallery = function(caseIndex, startIndex){
    const g = (window.CASE_GALLERY_HOME && window.CASE_GALLERY_HOME[caseIndex]) || null;
    if (!g || !g.length) return;
    window.openLightbox(g, startIndex || 0);
  };

  // Cases (все картинки)
  window.openCaseGallery = function(caseIndex, startIndex){
    const g = (window.CASE_GALLERY_ALL && window.CASE_GALLERY_ALL[caseIndex]) || null;
    if (!g || !g.length) return;
    window.openLightbox(g, startIndex || 0);
  };
})();
</script>

<script>
/* ===== Lightbox (с клавиатурой) ===== */
(function(){
  var LIGHTBOX = document.getElementById('lightbox');
  var IMG = document.getElementById('lightbox-img');
  var CAP = document.getElementById('lightbox-caption');
  var THUMBS = document.getElementById('lightbox-thumbs');
  var STAGE = document.querySelector('.lightbox-stage');
  var state = { arr:[], i:0 };
  var onKey = null;

  function setLoading(on){
    if (!STAGE) return;
    STAGE.classList.toggle('is-loading', !!on);
  }

  window.openLightbox = function(arr, index){
    state.arr = arr || [];
    state.i = Math.max(0, Math.min(index || 0, state.arr.length - 1));
    if (!state.arr.length) return;

    LIGHTBOX.style.display = 'block';
    document.body.classList.add('lb-lock');
    bindKeys();
    render();
  };

  window.closeLightbox = function(){
    LIGHTBOX.style.display = 'none';
    document.body.classList.remove('lb-lock');
    unbindKeys();
  };

  window.lightboxPrev = function(){ if (state.i>0){ state.i--; render(); } };
  window.lightboxNext = function(){ if (state.i<state.arr.length-1){ state.i++; render(); } };

  function bindKeys(){
    if (onKey) return;
    onKey = function(e){
      if (e.key === 'Escape'){ window.closeLightbox(); }
      else if (e.key === 'ArrowLeft'){ window.lightboxPrev(); }
      else if (e.key === 'ArrowRight'){ window.lightboxNext(); }
    };
    window.addEventListener('keydown', onKey);
  }
  function unbindKeys(){
    if (!onKey) return;
    window.removeEventListener('keydown', onKey);
    onKey = null;
  }

  function render(){
    var item = state.arr[state.i]; if (!item) return;
    setLoading(true);
    IMG.onload = function(){ setLoading(false); };
    IMG.onerror = function(){ setLoading(false); };
    IMG.src = item.src;
    CAP.textContent = item.caption || '';
    renderThumbs();
  }

  function renderThumbs(){
    if (!THUMBS) return;
    var wrap = document.createElement('div');
    wrap.className = 'lightbox-thumbs';
    state.arr.forEach(function(it, idx){
      var t = document.createElement('img');
      t.className = 'lightbox-thumb' + (idx===state.i ? ' is-active' : '');
      t.src = it.src; t.alt = it.caption || '';
      t.onclick = function(){ state.i = idx; render(); };
      wrap.appendChild(t);
    });
    THUMBS.innerHTML = '';
    THUMBS.appendChild(wrap);
  }
})();
</script>

<script>
/* ===== Cases galleries data ===== */
window.CASE_GALLERY_HOME = [
  {% for c in site.cases %}
    (function(){
      var arr = [];
      {% if c.stages %}
        {% for st in c.stages %}
          {% for img in st.images %}
            {% unless img.home == false %}
              {% assign src = img.src | default:img.file | prepend:c.images_base | default:img.src %}
              arr.push({ src:"{{ site.baseurl }}{{ src }}", caption:{{ img.caption | jsonify }} });
            {% endunless %}
          {% endfor %}
        {% endfor %}
      {% elsif c.images %}
        {% for img in c.images %}
          {% unless img.home == false %}
            {% assign src = img.src | default:img.file | prepend:c.images_base | default:img.src %}
            arr.push({ src:"{{ site.baseurl }}{{ src }}", caption:{{ img.caption | jsonify }} });
          {% endunless %}
        {% endfor %}
      {% endif %}
      return arr;
    })(){% unless forloop.last %},{% endunless %}
  {% endfor %}
];

window.CASE_GALLERY_ALL = [
  {% for c in site.cases %}
    (function(){
      var arr = [];
      {% if c.stages %}
        {% for st in c.stages %}
          {% for img in st.images %}
            {% assign src = img.src | default:img.file | prepend:c.images_base | default:img.src %}
            arr.push({ src:"{{ site.baseurl }}{{ src }}", caption:{{ img.caption | jsonify }} });
          {% endfor %}
        {% endfor %}
      {% elsif c.images %}
        {% for img in c.images %}
          {% assign src = img.src | default:img.file | prepend:c.images_base | default:img.src %}
          arr.push({ src:"{{ site.baseurl }}{{ src }}", caption:{{ img.caption | jsonify }} });
        {% endfor %}
      {% endif %}
      return arr;
    })(){% unless forloop.last %},{% endunless %}
  {% endfor %}
];
</script>

<script>
/* ===== Pet galleries data ===== */
window.PET_GALLERIES = [
  {% assign items = site.petprojects %}
  {% for p in items %}
    (function(){
      var arr = [];
      {% if p.gallery %}
        {% for img in p.gallery %}
          {% assign src = img.src | default:img.file | prepend:p.images_base | default:img.src %}
          arr.push({ src:"{{ site.baseurl }}{{ src }}", caption:{{ img.caption | jsonify }} });
        {% endfor %}
      {% endif %}
      return arr;
    })(){% unless forloop.last %},{% endunless %}
  {% endfor %}
];
</script>

<script>
/* ===== Lazy images (pet projects + cases/works) ===== */
(function(){
  function loadLazyImage(img){
    if (img.dataset._loading) return;
    img.dataset._loading = '1';

    var src = img.getAttribute('data-src');
    if (!src) return;

    var ph = new Image();
    ph.onload = function(){
      img.src = src;
      (img.decode ? img.decode() : Promise.resolve())
        .catch(function(){})
        .finally(function(){
          img.classList.add('is-loaded');
          var box = img.closest('.case-img-wrap, .pp-media, .pp-media-link');
          if (box) box.classList.add('has-loaded');
        });
    };
    ph.onerror = function(){
      img.classList.add('is-loaded');
      var box = img.closest('.case-img-wrap, .pp-media, .pp-media-link');
      if (box) box.classList.add('has-loaded');
    };
    ph.src = src;
  }

  var io = ('IntersectionObserver' in window)
    ? new IntersectionObserver(function(entries){
        entries.forEach(function(entry){
          if (entry.isIntersecting) {
            io.unobserve(entry.target);
            loadLazyImage(entry.target);
          }
        });
      }, { rootMargin: '200px 0px' })
    : null;

  function initLazy(){
    var imgs = document.querySelectorAll('img.lazy-img[data-src]');
    imgs.forEach(function(img){
      if (io) io.observe(img);
      else loadLazyImage(img);
    });
  }

  if (document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initLazy);
  } else {
    initLazy();
  }
})();
</script>
  </body>
</html>
