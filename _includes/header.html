<div class="nav-wrapper">
  <header>
{% assign cur_lang = 'en' %}
{% if page.url and page.url | slice: 0,4 == '/ru/' %}
  {% assign cur_lang = 'ru' %}
{% endif %}
{% if page.lang %}
  {% assign cur_lang = page.lang %}
{% endif %}

    {% comment %} Логотип по языку {% endcomment %}
    <div class="logo">
      <a href="{{ site.baseurl }}{% if cur_lang == 'ru' %}/ru/{% else %}/{% endif %}">
        <img
          src="{{ site.baseurl }}{% if cur_lang == 'ru' %}/ui/logo_ru.svg{% else %}/ui/logo_en.svg{% endif %}"
          alt="Logo"
          class="logo-img">
      </a>
    </div>

    <div class="menu-panel">
      <div class="menu-block">

        {% comment %} Навигация из data-файла по языку, с fallback на legacy navigation.yml {% endcomment %}
        {% assign nav_key = 'navigation_' | append: cur_lang %}
        {% assign nav_data = site.data[nav_key] | default: site.data.navigation %}
        {% assign nav = nav_data.main %}
        {% assign pageurl = page.url %}

        <nav class="main-menu">
          {% for item in nav %}
            {% assign is_current = false %}
            {% if item.url == pageurl %}
              {% assign is_current = true %}
            {% else %}
              {% if item.subnav %}
                {% for sub in item.subnav %}
                  {% if sub.url == pageurl %}
                    {% assign is_current = true %}
                  {% endif %}
                {% endfor %}
              {% endif %}
            {% endif %}
            <a href="{{ site.baseurl }}{{ item.url }}" class="menu-link{% if is_current %} current{% endif %}">{{ item.title }}</a>
          {% endfor %}
        </nav>

        {% comment %} Сабнавигация — как было {% endcomment %}
        {%- assign current_main = nil -%}
        {%- for item in nav -%}
          {%- if item.url == pageurl -%}
            {%- assign current_main = item -%}
          {%- elsif item.subnav -%}
            {%- for sub in item.subnav -%}
              {%- if sub.url == pageurl -%}
                {%- assign current_main = item -%}
              {%- endif -%}
            {%- endfor -%}
          {%- endif -%}
        {%- endfor -%}

        {%- if current_main and current_main.subnav -%}
          <nav class="subnav">
            {% for sub in current_main.subnav %}
              <a href="{{ site.baseurl }}{{ sub.url }}" class="sub-link{% if sub.url == pageurl %} current{% endif %}">{{ sub.title }}</a>
            {% endfor %}
          </nav>
        {%- endif -%}

      </div>
    </div>
  </header>
</div>

{%- comment -%}
  Плавающий переключатель языка (RUS / ENG):
  - первый показ за СЕССИЮ: через 2s в правом верхнем углу → плавный перезд к финальной позиции у левого верхнего угла с "выцветанием"
  - повторные визиты в этой сессии: сразу в финальном месте и блеклый
{%- endcomment -%}
<a id="lang-floater" class="lang-floater" href="#"></a>
<script>
(function(){
  var KEY='langIntroSeen';
  var seen=false; try{ seen=sessionStorage.getItem(KEY)==='1'; }catch(e){}
  var cur='{{ cur_lang }}';
  var other=(cur==='ru')?'ENG':'RUS';
  var url='{{ page.url | default: "/" }}';
  var alt='{{ page.alt_url | default: "" }}';
  var base='{{ site.baseurl }}';
  var otherUrl = alt && alt!=='' ? (base+alt)
               : (cur==='ru' ? base+url.replace(/^\/ru\//,'/')
                              : base+(url==='/'?'/ru/':'/ru'+url));
  var el=document.getElementById('lang-floater');
  if(!el) return;
  el.textContent=other;
  el.href=otherUrl;
  el.style.pointerEvents='auto';
  if(seen){ el.classList.add('settled'); return; }
  el.classList.add('pre');
  setTimeout(function(){
    el.classList.remove('pre');
    el.classList.add('intro');
    try{ sessionStorage.setItem(KEY,'1'); }catch(e){}
  },2000);
})();
</script>
